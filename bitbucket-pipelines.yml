image: amazonlinux

pipelines:
  branches:
    main:
      - step:
          name: Build & Deploy to S3
          caches:
            - node
            - custom-aws-cli  # ðŸ‘ˆ Manually defined cache
          script:
            - echo "Installing dependencies..."
            - mkdir -p /opt/aws-cli
            - if [ ! -f /opt/aws-cli/bin/aws ]; then yum install -y unzip aws-cli && cp -r /usr/local/bin/aws* /opt/aws-cli/; fi
            - export PATH="/opt/aws-cli/bin:$PATH"

            - echo "Configuring AWS credentials..."
            - export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
            - export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
            - export AWS_REGION=$AWS_REGION

            - echo "Checking AWS CLI version..."
            - aws --version  # âœ… Verifies AWS CLI is installed

            - echo "Deploying React app..."
            - npm install
            - npm run build

            - echo "Uploading to S3..."
            - aws s3 sync ./dist s3://$AWS_S3_BUCKET --delete

            - echo "Invalidating CloudFront cache..."
            - aws cloudfront create-invalidation --distribution-id $AWS_CLOUDFRONT_DISTRIBUTION_ID --paths "/*"

definitions:
  caches:
    custom-aws-cli: /opt/aws-cli  # ðŸ‘ˆ Custom cache for AWS CLI
