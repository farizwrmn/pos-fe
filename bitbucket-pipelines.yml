image: node:20

pipelines:
  branches:
    main:
      - step:
          name: Install dependencies with Yarn
          caches:
            - yarn
          script:
            - yarn install --frozen-lockfile
            - yarn build
            - yarn test
          artifacts:
            - dist/**
      - step:
          name: Deploy to S3 and Invalidate CloudFront
          deployment: production
          script:
            # Install AWS CLI (needed for more control than the pipe provides)
            - apt-get update && apt-get install -y python3-pip
            - pip3 install awscli
            # Deploy to S3
            - aws s3 sync dist/ s3://${AWS_S3_BUCKET} --delete --acl public-read
            # Invalidate CloudFront cache
            - aws cloudfront create-invalidation --distribution-id ${AWS_CLOUDFRONT_DISTRIBUTION_ID} --paths "/*"