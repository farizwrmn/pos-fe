image: amazonlinux

pipelines:
  branches:
    master:
      - step:
          name: Build & Deploy to S3
          caches:
            - node
          script:
            - echo "Installing dependencies..."
            - yum install -y unzip
            - curl "https://awscli.amazonaws.com/AWSCLIV2.pkg" -o "AWSCLIV2.pkg"
            - sudo installer -pkg AWSCLIV2.pkg -target /
            - aws --version


            - echo "Installing yarn..."
            - curl -fsSL https://dl.yarnpkg.com/rpm/yarn.repo | tee /etc/yum.repos.d/yarn.repo
            - yum install -y yarn
            - export PATH="/opt/aws-cli/bin:$PATH"

            - echo "Configuring AWS credentials..."
            - export AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
            - export AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
            - export AWS_REGION=$AWS_REGION

            - echo "Checking AWS CLI version..."
            - aws --version  # âœ… Verifies AWS CLI is installed

            - echo "Deploying React app..."
            - yarn
            - yarn build

            - echo "Uploading to S3..."
            - aws s3 sync ./dist s3://$AWS_S3_BUCKET --delete

            - echo "Invalidating CloudFront cache..."
            - aws cloudfront create-invalidation --distribution-id $AWS_CLOUDFRONT_DISTRIBUTION_ID --paths "/*"

